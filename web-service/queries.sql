

-- getGetEGRIDResponseTypeByXY
SELECT parcels.t_id, 
  CASE 
    WHEN g.egris_egrid IS NULL THEN 'CH-DUMMY' 
    ELSE g.egris_egrid 
  END AS egrid, 
  g.nbident AS identdn, 
  g.nummer AS number,
  'valid' AS validitytype, -- opposite: planned
  CASE
    WHEN g.art = 'Liegenschaft' THEN 'RealEstate' 
    ELSE 'Distinct_and_permanent_rights.BuildingRight'
  END AS realestatetype
FROM 
  ( 
    SELECT t_id,  
      geometrie AS geometrie, 
      liegenschaft_von AS grundstueck_fk 
    FROM 
      agi_avdpool.liegenschaften_liegenschaft 
    UNION ALL 
    SELECT t_id,  
      geometrie AS geometrie, 
      selbstrecht_von AS grundstueck_fk 
    FROM 
      agi_avdpool.liegenschaften_selbstrecht 
  ) AS parcels 
  LEFT JOIN agi_avdpool.liegenschaften_grundstueck AS g 
  ON g.t_id = parcels.grundstueck_fk 
WHERE 
  ST_Intersects(ST_SetSRID(ST_MakePoint(:x, :y),2056), geometrie) 
;


-- getGetEGRIDResponseTypeByGNSS
SELECT parcels.t_id, 
  CASE 
    WHEN g.egris_egrid IS NULL THEN 'CH-DUMMY' 
    ELSE g.egris_egrid 
  END AS egrid, 
  g.nbident AS identdn, 
  g.nummer AS number,
  'valid' AS validitytype, -- opposite: planned
  CASE
    WHEN g.art = 'Liegenschaft' THEN 'RealEstate' 
    ELSE 'Distinct_and_permanent_rights.BuildingRight'
  END AS realestatetype
FROM 
  ( 
    SELECT t_id,  
      geometrie AS geometrie, 
      liegenschaft_von AS grundstueck_fk 
    FROM 
      agi_avdpool.liegenschaften_liegenschaft 
    UNION ALL 
    SELECT t_id,  
      geometrie AS geometrie, 
      selbstrecht_von AS grundstueck_fk 
    FROM 
      agi_avdpool.liegenschaften_selbstrecht 
  ) AS parcels 
  LEFT JOIN agi_avdpool.liegenschaften_grundstueck AS g 
  ON g.t_id = parcels.grundstueck_fk 
WHERE 
  ST_Intersects(ST_Transform(ST_SetSRID(ST_MakePoint(:x, :y),4326),2056), geometrie) 
;

-- getGetEGRIDResponseTypeByNumberAndIdentDN
SELECT parcels.t_id, 
  CASE 
    WHEN g.egris_egrid IS NULL THEN 'CH-DUMMY' 
    ELSE g.egris_egrid 
  END AS egrid, 
  g.nbident AS identdn, 
  g.nummer AS number,
  'valid' AS validitytype, -- opposite: planned
  CASE
    WHEN g.art = 'Liegenschaft' THEN 'RealEstate' 
    ELSE 'Distinct_and_permanent_rights.BuildingRight'
  END AS realestatetype
FROM 
  ( 
    SELECT t_id,  
      geometrie AS geometrie, 
      liegenschaft_von AS grundstueck_fk 
    FROM 
      agi_avdpool.liegenschaften_liegenschaft 
    UNION ALL 
    SELECT t_id,  
      geometrie AS geometrie, 
      selbstrecht_von AS grundstueck_fk 
    FROM 
      agi_avdpool.liegenschaften_selbstrecht 
  ) AS parcels 
  LEFT JOIN agi_avdpool.liegenschaften_grundstueck AS g 
  ON g.t_id = parcels.grundstueck_fk 
WHERE 
  g.nbident = :identdn AND g.nummer = :number 
;

-- getGetEGRIDResponseTypeByPostalcodeAndLocalisationAndNumber
SELECT DISTINCT 
  CASE 
    WHEN g.egris_egrid IS NULL THEN 'CH-DUMMY' 
    ELSE g.egris_egrid 
  END AS egrid, 
  g.nbident AS identdn, 
  g.nummer AS "number" 
FROM 
  ( 
    SELECT 
      t_id, 
      gebaeudeeingang_von, 
      hausnummer, 
      lage 
    FROM   
      agi_avdpool.gebaeudeadressen_gebaeudeeingang 
    WHERE 
      hausnummer IS NOT NULL 
      AND 
      istoffiziellebezeichnung = 'ja' 
  ) AS gebein 
  LEFT JOIN agi_avdpool.gebaeudeadressen_lokalisation AS lok 
  ON gebein.gebaeudeeingang_von = lok.t_id 
  LEFT JOIN agi_avdpool.gebaeudeadressen_lokalisationsname AS lokname 
  ON lokname.benannte = lok.t_id 
  INNER JOIN  
  ( 
    SELECT 
      geometrie AS geometrie, 
      liegenschaft_von AS grundstueck_fk 
    FROM 
      agi_avdpool.liegenschaften_liegenschaft 
    UNION ALL 
    SELECT 
      geometrie AS geometrie, 
      selbstrecht_von AS grundstueck_fk 
    FROM 
      agi_avdpool.liegenschaften_selbstrecht 
  ) AS parcels 
  ON ST_Intersects(gebein.lage, parcels.geometrie) 
  LEFT JOIN agi_plzortschaft.plzortschaft_plz6 AS plz 
  ON ST_Intersects(gebein.lage, plz.flaeche) 
  LEFT JOIN agi_avdpool.liegenschaften_grundstueck AS g 
  ON g.t_id = parcels.grundstueck_fk 
WHERE 
  lokname.atext IS NOT NULL /* Due to errors (?) in the data. */ 
  AND plz.plz = CAST(:postalcode AS INTEGER)
  AND lokname.atext = :localisation 
  AND gebein.hausnummer = :number 
;

-- getThemesByParcelGeometry
WITH parcel AS (
  SELECT ST_PolygonFromText('POLYGON((2597769.704 1225811.232,2597902.559 1225818.433,2598006.279 1225824.053,2598110.878 1225829.595,2598112.57386898 1225829.65589813,2598114.2699798 1225829.70964085,2598115.96630227 1225829.75622723,2598117.66280618 1225829.79565643,2598119.35946135 1225829.82792774,2598121.05623757 1225829.8530406,2598122.75310464 1225829.87099455,2598124.45003235 1225829.88178927,2598126.14699051 1225829.88542458,2598127.8439489 1225829.88190041,2598129.54087731 1225829.87121682,2598131.23774555 1225829.853374,2598132.93452341 1225829.82837227,2598134.63118069 1225829.79621208,2598136.32768718 1225829.75689399,2598138.0240127 1225829.71041871,2598139.72012703 1225829.65678706,2598141.416 1225829.596,2598143.11165399 1225829.52805639,2598144.80700623 1225829.45295922,2598146.50202654 1225829.37070983,2598148.19668473 1225829.28130967,2598149.89095066 1225829.18476034,2598151.58479415 1225829.08106355,2598153.27818506 1225828.97022116,2598154.97109323 1225828.85223514,2598156.66348854 1225828.72710758,2598158.35534086 1225828.59484072,2598160.04662008 1225828.4554369,2598161.73729607 1225828.30889862,2598163.42733876 1225828.15522847,2598165.11671805 1225827.9944292,2598166.80540388 1225827.82650366,2598168.49336617 1225827.65145485,2598170.18057489 1225827.46928588,2598171.867 1225827.28,2598173.64445711 1225827.07259169,2598175.42097375 1225826.85727655,2598177.19651476 1225826.63405883,2598178.97104496 1225826.40294297,2598180.74452924 1225826.16393353,2598182.51693247 1225825.91703524,2598184.28821958 1225825.66225301,2598186.05835548 1225825.39959186,2598187.82730514 1225825.129057,2598189.59503352 1225824.85065379,2598191.36150564 1225824.56438773,2598193.12668651 1225824.2702645,2598194.8905412 1225823.96828993,2598196.65303477 1225823.65846997,2598198.41413233 1225823.34081078,2598200.17379902 1225823.01531864,2598201.932 1225822.682,2598203.68872708 1225822.34085622,2598205.44391881 1225821.99189905,2598207.19754044 1225821.6351354,2598208.94955725 1225821.27057233,2598210.69993455 1225820.89821707,2598212.44863768 1225820.51807698,2598214.19563202 1225820.13015959,2598215.94088298 1225819.73447258,2598217.68435601 1225819.33102379,2598219.42601658 1225818.91982121,2598221.16583022 1225818.50087297,2598222.90376247 1225818.07418737,2598224.63977894 1225817.63977285,2598226.37384523 1225817.19763803,2598228.10592703 1225816.74779165,2598229.83599004 1225816.29024262,2598231.564 1225815.825,2598273.585 1225804.298,2598392.623 1225772.029,2598520.985 1225737.1,2598646.244 1225702.434,2598765.327 1225669.167,2598786.981 1225662.88,2598794.707 1225660.037,2598793.295 1225655.981,2598745.026 1225634.857,2598744.015 1225636.802,2598630.617 1225586.599,2598628.555 1225580.716,2598636.117 1225563.973,2598635.953 1225563.9,2598426.43 1225470.844,2598420.31 1225483.867,2598420.3 1225484.134,2598418.74 1225487.51,2598416.714 1225482.17,2598207.384 1225388.561,2598201.858 1225390.401,2598235.912 1225313.965,2598031.139 1225222.872,2598008.848 1225272.023,2598007.188 1225275.692,2598002.842 1225273.061,2598000.764 1225277.661,2597975.173 1225334.321,2597953.987 1225381.216,2597916.837 1225463.231,2597884.995 1225533.619,2597834.276 1225510.51,2597834.9392786 1225512.10918733,2597835.59530463 1225513.7113635,2597836.24406461 1225515.31649562,2597836.88554522 1225516.92455073,2597837.51973331 1225518.53549583,2597838.14661583 1225520.14929784,2597838.76617994 1225521.76592363,2597839.3784129 1225523.38534002,2597839.98330215 1225525.00751375,2597840.58083527 1225526.63241153,2597841.171 1225528.26,2597841.75376946 1225529.89020416,2597842.32914681 1225531.52303199,2597842.89712026 1225533.15844998,2597843.45767814 1225534.79642455,2597844.01080895 1225536.43692209,2597844.55650132 1225538.0799089,2597845.09474406 1225539.72535127,2597845.62552612 1225541.37321542,2597846.14883659 1225543.02346751,2597846.66466475 1225544.67607368,2597847.173 1225546.331,2597851.8 1225561.514,2597852.02913677 1225562.27696454,2597852.25234501 1225563.04168452,2597852.46961125 1225563.80811386,2597852.68092242 1225564.5762064,2597852.88626579 1225565.34591586,2597853.08562899 1225566.11719588,2597853.279 1225566.89,2597853.46638797 1225567.66436904,2597853.64775946 1225568.44016931,2597853.82310354 1225569.21735404,2597853.99240966 1225569.99587643,2597854.1556676 1225570.77568955,2597854.31286754 1225571.55674643,2597854.464 1225572.339,2597854.61766625 1225573.17044751,2597854.76446502 1225574.00313496,2597854.90438632 1225574.83700564,2597855.03742061 1225575.67200274,2597855.16355883 1225576.50806938,2597855.28279238 1225577.34514861,2597855.39511315 1225578.18318341,2597855.50051348 1225579.02211668,2597855.5989862 1225579.8618913,2597855.69052459 1225580.70245004,2597855.77512242 1225581.54373565,2597855.85277393 1225582.38569083,2597855.92347383 1225583.22825822,2597855.9872173 1225584.07138042,2597856.044 1225584.915,2597856.09381493 1225585.75900247,2597856.13666277 1225586.60338731,2597856.17254061 1225587.44809701,2597856.20144599 1225588.29307404,2597856.22337695 1225589.13826084,2597856.238332 1225589.98359985,2597856.24631011 1225590.8290335,2597856.24731074 1225591.67450419,2597856.24133383 1225592.51995435,2597856.22837979 1225593.3653264,2597856.20844949 1225594.21056274,2597856.18154429 1225595.05560582,2597856.14766602 1225595.90039808,2597856.106817 1225596.74488198,2597856.059 1225597.589,2597856.00310794 1225598.44997034,2597855.93995956 1225599.3104389,2597855.86955934 1225600.17034451,2597855.79191229 1225601.02962607,2597855.70702392 1225601.8882225,2597855.61490028 1225602.74607277,2597855.51554791 1225603.60311592,2597855.40897386 1225604.45929103,2597855.29518572 1225605.31453726,2597855.17419156 1225606.16879382,2597855.046 1225607.022,2597854.91063013 1225607.87403394,2597854.76808261 1225608.72489648,2597854.61836757 1225609.57452713,2597854.46149566 1225610.42286554,2597854.29747802 1225611.2698514,2597854.12632631 1225612.11542454,2597853.94805268 1225612.95952487,2597853.76266981 1225613.80209239,2597853.57019087 1225614.64306725,2597853.37062954 1225615.48238966,2597853.164 1225616.32,2597853.00923023 1225616.9274461,2597852.851 1225617.534,2597852.68922688 1225618.1399663,2597852.524 1225618.745,2597852.46339236 1225618.97822999,2597852.41030634 1225619.21328613,2597852.36479672 1225619.44992592,2597852.32691045 1225619.68790522,2597852.29668662 1225619.9269785,2597852.2741564 1225620.16689912,2597852.25934304 1225620.40741955,2597852.25226182 1225620.64829166,2597852.25292006 1225620.88926693,2597852.26131706 1225621.13009675,2597852.27744417 1225621.37053267,2597852.30128475 1225621.61032663,2597852.3328142 1225621.84923123,2597852.372 1225622.087,2597852.41880531 1225622.32340438,2597852.47317932 1225622.5581835,2597852.53506593 1225622.79109511,2597852.60440128 1225623.02189887,2597852.68111383 1225623.25035664,2597852.76512443 1225623.47623269,2597852.85634638 1225623.69929394,2597852.95468557 1225623.91931024,2597853.06004051 1225624.13605457,2597853.17230252 1225624.34930328,2597853.29135574 1225624.55883633,2597853.41707733 1225624.76443752,2597853.54933758 1225624.9658947,2597853.688 1225625.163,2597852.731 1225627.871,2597848.464 1225638.089,2597841.799 1225653.942,2597839.495 1225652.974,2597839.33452764 1225653.34505834,2597839.16676102 1225653.71287627,2597838.99176552 1225654.07731041,2597838.80960937 1225654.43821871,2597838.62036357 1225654.7954605,2597838.42410188 1225655.14889652,2597838.2209008 1225655.49838899,2597838.01083955 1225655.8438017,2597837.794 1225656.185,2597837.57044737 1225656.52187937,2597837.34028698 1225656.85427927,2597837.10360856 1225657.18207008,2597836.86050439 1225657.50512403,2597836.61106925 1225657.82331517,2597836.35540036 1225658.13651944,2597836.09359743 1225658.44461474,2597835.8257625 1225658.74748095,2597835.552 1225659.045,2597835.30772293 1225659.31012723,2597835.06838655 1225659.57972291,2597834.83407257 1225659.85369497,2597834.60486101 1225660.13194988,2597834.38083013 1225660.41439261,2597834.16205643 1225660.70092673,2597833.94861461 1225660.9914544,2597833.74057755 1225661.2858764,2597833.53801629 1225661.58409221,2597833.341 1225661.886,2597833.14964555 1225662.19141587,2597832.96396568 1225662.5003145,2597832.78402378 1225662.81259049,2597832.60988125 1225663.12813725,2597832.44159753 1225663.4468471,2597832.27923004 1225663.76861126,2597832.12283419 1225664.09331993,2597831.97246337 1225664.42086229,2597831.82816889 1225664.75112655,2597831.69 1225665.084,2597813.361 1225708.666,2597811.34 1225713.476,2597810.096 1225716.43,2597820.225 1225721.039,2597858.084 1225637.867,2597936.502 1225672.275,2597917.861 1225713.54,2597917.47 1225713.36,2597898.017 1225756.288,2597966.708 1225787.412,2598015.047 1225809.342,2598011.833 1225816.304,2598006.49 1225820.005,2597902.76 1225814.385,2597778.119 1225807.69,2597777.90159239 1225807.65203672,2597777.68556512 1225807.60687598,2597777.47115638 1225807.55456757,2597777.2586026 1225807.49516918,2597777.04813817 1225807.42874629,2597776.83999515 1225807.35537216,2597776.63440308 1225807.27512769,2597776.43158864 1225807.18810137,2597776.23177548 1225807.09438916,2597776.03518393 1225806.99409439,2597775.84203077 1225806.88732766,2597775.65252899 1225806.7742067,2597775.46688754 1225806.65485625,2597775.28531114 1225806.5294079,2597775.108 1225806.398,2597774.93512632 1225806.26075829,2597774.76690532 1225806.1178517,2597774.60352254 1225805.96943787,2597774.4451582 1225805.81568049,2597774.29198697 1225805.65674915,2597774.14417779 1225805.49281916,2597774.00189369 1225805.32407132,2597773.86529162 1225805.15069177,2597773.73452224 1225804.97287173,2597773.60972978 1225804.79080734,2597773.49105191 1225804.60469942,2597773.3786195 1225804.41475324,2597773.27255659 1225804.22117831,2597773.17298014 1225804.02418814,2597773.08 1225803.824,2597769.704 1225811.232),(2597863.536 1225629.728,2597882.277 1225587.764,2597917.587 1225603.851,2597906.381 1225628.94,2597909.577 1225630.367,2597902.16 1225646.974,2597863.536 1225629.728),(2598062.774 1225801.933,2598062.65211382 1225801.61400487,2598062.53757703 1225801.29229777,2598062.43044989 1225800.96804801,2598062.33078879 1225800.64142621,2598062.23864617 1225800.31260427,2598062.15407052 1225799.98175522,2598062.07710635 1225799.64905318,2598062.00779416 1225799.31467322,2598061.94617043 1225798.97879133,2598061.89226759 1225798.64158424,2598061.84611399 1225798.30322943,2598061.80773394 1225797.96390495,2598061.77714763 1225797.62378936,2598061.75437115 1225797.28306167,2598061.73941649 1225796.94190116,2598061.73229153 1225796.60048738,2598061.733 1225796.259,2598061.74153986 1225795.9176648,2598061.75790618 1225795.57661527,2598061.78209035 1225795.23603081,2598061.81407964 1225794.89609062,2598061.85385723 1225794.55697355,2598061.90140218 1225794.21885801,2598061.9566895 1225793.88192187,2598062.01969007 1225793.54634242,2598062.09037078 1225793.21229619,2598062.16869441 1225792.87995893,2598062.25461978 1225792.54950549,2598062.34810167 1225792.22110972,2598062.44909091 1225791.8949444,2598062.55753435 1225791.57118111,2598062.67337496 1225791.24999021,2598062.79655177 1225790.93154066,2598062.927 1225790.616,2598068.999 1225776.946,2598119.006 1225799.197,2598126.608 1225802.562,2598124.328 1225807.748,2598125.814 1225808.437,2598125.468 1225809.341,2598126.819 1225809.936,2598123.452 1225817.562,2598112.895 1225812.92,2598112.73456917 1225813.18285538,2598112.56799788 1225813.44186311,2598112.39537835 1225813.69687977,2598112.21680617 1225813.94776416,2598112.03238022 1225814.19437735,2598111.84220262 1225814.4365828,2598111.64637867 1225814.67424639,2598111.4450168 1225814.90723651,2598111.23822852 1225815.13542417,2598111.02612832 1225815.358683,2598110.80883365 1225815.57688938,2598110.58646483 1225815.7899225,2598110.35914499 1225815.99766438,2598110.127 1225816.2,2598109.89017517 1225816.39680371,2598109.64878551 1225816.58798094,2598109.40296467 1225816.77342585,2598109.15284873 1225816.95303575,2598108.89857617 1225817.12671122,2598108.64028778 1225817.29435609,2598108.37812654 1225817.45587756,2598108.1122376 1225817.6111862,2598107.84276817 1225817.76019602,2598107.56986744 1225817.90282453,2598107.29368649 1225818.03899275,2598107.01437824 1225818.16862531,2598106.73209731 1225818.29165043,2598106.447 1225818.408,2598106.1567842 1225818.51851943,2598105.86402939 1225818.62212629,2598105.56890021 1225818.71876233,2598105.27156261 1225818.8083732,2598104.97218379 1225818.89090852,2598104.67093209 1225818.96632186,2598104.36797692 1225819.03457084,2598104.06348864 1225819.09561706,2598103.75763846 1225819.1494262,2598103.45059837 1225819.195968,2598103.14254102 1225819.23521629,2598102.83363965 1225819.26714901,2598102.52406795 1225819.29174819,2598102.214 1225819.309,2598101.90357411 1225819.31889546,2598101.59300085 1225819.32142658,2598101.28245491 1225819.31659194,2598100.97211096 1225819.30439424,2598100.66214354 1225819.28484036,2598100.352727 1225819.25794129,2598100.04403538 1225819.22371215,2598099.73624229 1225819.18217221,2598099.42952085 1225819.13334483,2598099.12404358 1225819.07725747,2598098.8199823 1225819.01394167,2598098.51750802 1225818.94343305,2598098.21679087 1225818.86577127,2598097.918 1225818.781,2598070.629 1225810.086,2598070.3178571 1225809.94509967,2598070.01003038 1225809.79709456,2598069.70568204 1225809.64206265,2598069.40497246 1225809.48008564,2598069.10806009 1225809.31124888,2598068.8151014 1225809.13564134,2598068.52625075 1225808.95335555,2598068.24166035 1225808.76448758,2598067.96148017 1225808.56913694,2598067.68585785 1225808.36740657,2598067.41493863 1225808.15940277,2598067.14886526 1225807.94523516,2598066.88777795 1225807.72501657,2598066.63181429 1225807.49886307,2598066.38110914 1225807.26689382,2598066.13579462 1225807.02923105,2598065.896 1225806.786,2598065.66182629 1225806.5373013,2598065.43342349 1225806.28329237,2598065.21091199 1225806.02410709,2598064.99440906 1225805.75988208,2598064.78402882 1225805.49075659,2598064.57988214 1225805.21687247,2598064.38207664 1225804.93837408,2598064.19071656 1225804.65540819,2598064.00590275 1225804.36812396,2598063.82773264 1225804.07667279,2598063.65630012 1225803.78120829,2598063.49169555 1225803.48188621,2598063.33400569 1225803.17886429,2598063.18331365 1225802.87230225,2598063.03969886 1225802.56236167,2598062.903237 1225802.2492059,2598062.774 1225801.933),(2598175.504 1225801.534,2598201.932 1225797.073,2598203.671 1225807.414,2598177.255 1225811.871,2598175.504 1225801.534),(2598185.714 1225775.423,2598201.771 1225739.827,2598269.089 1225770.193,2598253.032 1225805.789,2598185.714 1225775.423),(2598212.096 1225804.322,2598218.448 1225802.942,2598219.55 1225808.038,2598213.192 1225809.424,2598212.096 1225804.322))', 2056) AS geom
)
,
eigentumsbeschraenkung_geometrie AS (
  SELECT
    eigentumsbeschraenkung
  FROM
    agi_oereb.transferstruktur_geometrie AS geometrie,
    parcel
  WHERE
    ST_Intersects(geometrie.flaeche_lv95, parcel.geom)
    OR
    ST_Intersects(geometrie.linie_lv95, parcel.geom)
    OR
    ST_Intersects(geometrie.punkt_lv95, parcel.geom)
)
,
eigentumsbeschraenkung AS (
  SELECT
    DISTINCT ON (thema)
    thema
  FROM
    agi_oereb.transferstruktur_eigentumsbeschraenkung AS eigentumsbeschraenkung
    INNER JOIN eigentumsbeschraenkung_geometrie
    ON eigentumsbeschraenkung_geometrie.eigentumsbeschraenkung = eigentumsbeschraenkung.t_id
)
SELECT
  CASE 
    WHEN eigentumsbeschraenkung.thema IS NULL THEN FALSE
    ELSE TRUE
  END AS concerned,
  thema.ilicode,
  katasterthema.code AS code,
  katasterthema.aname_de AS "text",
  katasterthema.daten_vorhanden AS hasdata
FROM
  agi_oereb.thema AS thema 
  LEFT JOIN eigentumsbeschraenkung
  ON thema.ilicode = eigentumsbeschraenkung.thema
  LEFT JOIN agi_oereb_azg_ann.katasterauszgnnex_katasterthema AS katasterthema
  ON katasterthema.thema = thema.ilicode
WHERE
  thema.ilicode != 'WeiteresThema'  
;